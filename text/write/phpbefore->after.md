# 大改修！PHPレガシーコードビフォーアフター参加レポート
## 開催概要
### 日時/場所
2019/11/30　メルカリ本社
### 開催テーマ
やること：主催者が運営しているサービスのソースをPHPer5人に渡して大改造ビフォアアフターする。
経緯：主催者はPHPでカンファレンス支援システム(*Fortee*)を制作している。別アプリとも連携しており、そろそろ技術的負債が溜まって来ているため「大改造やろうぜ」というノリで開催が決まった。

### 問題
- フレームワークはバージョンを追従してない
- マイクロサービスに程遠いモノシリックなコード
- テストがごく一部しか存在しない（そしてテストが壊れている部分もある）
- 突然現れる巨大なコントローラ
- テンプレートに書かれた if 文

### ツッコミどころ
技術的負債と言ってもCakePHP3とPHP7.0~7.3で動いている模様。


## PR:メルカリでのレガシーコード
### 概要：会場提供社であるメルカリでのレガシーコードリファクタリングの事例
メルカリにおけるレガシーコード※1：MarcariAPI（PHP or GO）
※1：価値を生み出しているレガシーコードはレジェンドコード※1と呼ぶべきではないか？

### 課題
- namespaceを使っていない
- fat controla, fat model
- JP/US/UK(撤退済み)で全て同じコード

### リファクタしたこと
当初は少人数での開発だったため問題が怒っていませんでしたが、機能の増加やエンジニアの増員等で複雑化→同時進行での開発によるバグに苦しめられることになった。
コントローラ/モデルはテストコードがあったため、リファクタだけで比較的素直に改善できたそう。
また、リージョン（国）ごとに使用するコードを完全分離。分離により検証範囲が狭小化され、開発スピードが上がったとのこと。

### Q&A
Q：リージョン分けると、別リージョンのコードを取り込もうとしてコンフリクトしたりするのでは？
A:少人数のころはコードを分けないほうが良かった。しかし実際はJP⇔US/UKで求められているものが異なるため、それぞれに特化した別物に作り直すほうがよいとわかった。現在はリージョンによってコードはほぼ別物。

### PR
メルカリ/メルペイではGO言語に挑戦したいPHPerを募集中です。

### 感想
最初は同じコードで運用していたけど、国によって求められるものが違うためコード/UIなどを分離したという話はZ.comでも聞いたなあと思いました。

### 参考
別件でメルカリのリファクタリングについて登壇された際の資料
https://tech.mercari.com/entry/phpstan


## 独立したコアレイヤパターンの適用
https://speakerdeck.com/shin1x1/fortee-meets-independent-core-layer-pattern

### 概要
forteeのソースコードに**ライブコーディング**でコアレイヤパターンを適用する。
使用するエディタはPHPstorm。

### コアレイヤパターンとは
アーキテクチャパターンの一つ。
システムをコアレイヤ、アプリケーションレイヤに分離する。詳しくはスライド資料参照。

### 既存の実装に対するリファクタのアイデア
- 漸進的に進め（0% or 100%で進めない）、少しずつ適用範囲を増やす
	- ロジックは同じでパターンの適用のみを行う
	- テスト後にロジックをリファクタリングする
	- コアレイヤが完成したらコントローラから実行する
- 適用する箇所を絞る
	- 単純な読み込みだけであれば適用しない

### おまけ
https://twitter.com/gatto_man/status/1200637064196190209